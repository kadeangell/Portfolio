(function(){"use strict";class b{static read_bytes(n,o){const R=new b;return R.buf=n.getUint32(o,!0),R.buf_len=n.getUint32(o+4,!0),R}static read_bytes_array(n,o,R){const g=[];for(let e=0;e<R;e++)g.push(b.read_bytes(n,o+8*e));return g}}class m{static read_bytes(n,o){const R=new m;return R.buf=n.getUint32(o,!0),R.buf_len=n.getUint32(o+4,!0),R}static read_bytes_array(n,o,R){const g=[];for(let e=0;e<R;e++)g.push(m.read_bytes(n,o+8*e));return g}}const p=2;class E{write_bytes(n,o){n.setUint8(o,this.fs_filetype),n.setUint16(o+2,this.fs_flags,!0),n.setBigUint64(o+8,this.fs_rights_base,!0),n.setBigUint64(o+16,this.fs_rights_inherited,!0)}constructor(n,o){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=n,this.fs_flags=o}}const D=0,x=1;class N{static read_bytes(n,o){return new N(n.getBigUint64(o,!0),n.getUint8(o+8),n.getUint32(o+16,!0),n.getBigUint64(o+24,!0),n.getUint16(o+36,!0))}constructor(n,o,R,g,e){this.userdata=n,this.eventtype=o,this.clockid=R,this.timeout=g,this.flags=e}}class T{write_bytes(n,o){n.setBigUint64(o,this.userdata,!0),n.setUint16(o+8,this.error,!0),n.setUint8(o+10,this.eventtype)}constructor(n,o,R){this.userdata=n,this.error=o,this.eventtype=R}}let C=class{enable(n){this.log=B(n===void 0?!0:n,this.prefix)}get enabled(){return this.isEnabled}constructor(n){this.isEnabled=n,this.prefix="wasi:",this.enable(n)}};function B(O,n){return O?console.log.bind(console,"%c%s","color: #265BA0",n):()=>{}}const w=new C(!1);class U extends Error{constructor(n){super("exit with exit code "+n),this.code=n}}let k=class{start(n){this.inst=n;try{return n.exports._start(),0}catch(o){if(o instanceof U)return o.code;throw o}}initialize(n){this.inst=n,n.exports._initialize&&n.exports._initialize()}constructor(n,o,R,g={}){this.args=[],this.env=[],this.fds=[],w.enable(g.debug),this.args=n,this.env=o,this.fds=R;const e=this;this.wasiImport={args_sizes_get(t,r){const s=new DataView(e.inst.exports.memory.buffer);s.setUint32(t,e.args.length,!0);let i=0;for(const f of e.args)i+=f.length+1;return s.setUint32(r,i,!0),w.log(s.getUint32(t,!0),s.getUint32(r,!0)),0},args_get(t,r){const s=new DataView(e.inst.exports.memory.buffer),i=new Uint8Array(e.inst.exports.memory.buffer),f=r;for(let a=0;a<e.args.length;a++){s.setUint32(t,r,!0),t+=4;const u=new TextEncoder().encode(e.args[a]);i.set(u,r),s.setUint8(r+u.length,0),r+=u.length+1}return w.enabled&&w.log(new TextDecoder("utf-8").decode(i.slice(f,r))),0},environ_sizes_get(t,r){const s=new DataView(e.inst.exports.memory.buffer);s.setUint32(t,e.env.length,!0);let i=0;for(const f of e.env)i+=new TextEncoder().encode(f).length+1;return s.setUint32(r,i,!0),w.log(s.getUint32(t,!0),s.getUint32(r,!0)),0},environ_get(t,r){const s=new DataView(e.inst.exports.memory.buffer),i=new Uint8Array(e.inst.exports.memory.buffer),f=r;for(let a=0;a<e.env.length;a++){s.setUint32(t,r,!0),t+=4;const u=new TextEncoder().encode(e.env[a]);i.set(u,r),s.setUint8(r+u.length,0),r+=u.length+1}return w.enabled&&w.log(new TextDecoder("utf-8").decode(i.slice(f,r))),0},clock_res_get(t,r){let s;switch(t){case 1:{s=5000n;break}case 0:{s=1000000n;break}default:return 52}return new DataView(e.inst.exports.memory.buffer).setBigUint64(r,s,!0),0},clock_time_get(t,r,s){const i=new DataView(e.inst.exports.memory.buffer);if(t===0)i.setBigUint64(s,BigInt(new Date().getTime())*1000000n,!0);else if(t==1){let f;try{f=BigInt(Math.round(performance.now()*1e6))}catch{f=0n}i.setBigUint64(s,f,!0)}else i.setBigUint64(s,0n,!0);return 0},fd_advise(t,r,s,i){return e.fds[t]!=null?0:8},fd_allocate(t,r,s){return e.fds[t]!=null?e.fds[t].fd_allocate(r,s):8},fd_close(t){if(e.fds[t]!=null){const r=e.fds[t].fd_close();return e.fds[t]=void 0,r}else return 8},fd_datasync(t){return e.fds[t]!=null?e.fds[t].fd_sync():8},fd_fdstat_get(t,r){if(e.fds[t]!=null){const{ret:s,fdstat:i}=e.fds[t].fd_fdstat_get();return i?.write_bytes(new DataView(e.inst.exports.memory.buffer),r),s}else return 8},fd_fdstat_set_flags(t,r){return e.fds[t]!=null?e.fds[t].fd_fdstat_set_flags(r):8},fd_fdstat_set_rights(t,r,s){return e.fds[t]!=null?e.fds[t].fd_fdstat_set_rights(r,s):8},fd_filestat_get(t,r){if(e.fds[t]!=null){const{ret:s,filestat:i}=e.fds[t].fd_filestat_get();return i?.write_bytes(new DataView(e.inst.exports.memory.buffer),r),s}else return 8},fd_filestat_set_size(t,r){return e.fds[t]!=null?e.fds[t].fd_filestat_set_size(r):8},fd_filestat_set_times(t,r,s,i){return e.fds[t]!=null?e.fds[t].fd_filestat_set_times(r,s,i):8},fd_pread(t,r,s,i,f){const a=new DataView(e.inst.exports.memory.buffer),u=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const _=b.read_bytes_array(a,r,s);let c=0;for(const d of _){const{ret:l,data:h}=e.fds[t].fd_pread(d.buf_len,i);if(l!=0)return a.setUint32(f,c,!0),l;if(u.set(h,d.buf),c+=h.length,i+=BigInt(h.length),h.length!=d.buf_len)break}return a.setUint32(f,c,!0),0}else return 8},fd_prestat_get(t,r){const s=new DataView(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const{ret:i,prestat:f}=e.fds[t].fd_prestat_get();return f?.write_bytes(s,r),i}else return 8},fd_prestat_dir_name(t,r,s){if(e.fds[t]!=null){const{ret:i,prestat:f}=e.fds[t].fd_prestat_get();if(f==null)return i;const a=f.inner.pr_name;return new Uint8Array(e.inst.exports.memory.buffer).set(a.slice(0,s),r),a.byteLength>s?37:0}else return 8},fd_pwrite(t,r,s,i,f){const a=new DataView(e.inst.exports.memory.buffer),u=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const _=m.read_bytes_array(a,r,s);let c=0;for(const d of _){const l=u.slice(d.buf,d.buf+d.buf_len),{ret:h,nwritten:y}=e.fds[t].fd_pwrite(l,i);if(h!=0)return a.setUint32(f,c,!0),h;if(c+=y,i+=BigInt(y),y!=l.byteLength)break}return a.setUint32(f,c,!0),0}else return 8},fd_read(t,r,s,i){const f=new DataView(e.inst.exports.memory.buffer),a=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const u=b.read_bytes_array(f,r,s);let _=0;for(const c of u){const{ret:d,data:l}=e.fds[t].fd_read(c.buf_len);if(d!=0)return f.setUint32(i,_,!0),d;if(a.set(l,c.buf),_+=l.length,l.length!=c.buf_len)break}return f.setUint32(i,_,!0),0}else return 8},fd_readdir(t,r,s,i,f){const a=new DataView(e.inst.exports.memory.buffer),u=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){let _=0;for(;;){const{ret:c,dirent:d}=e.fds[t].fd_readdir_single(i);if(c!=0)return a.setUint32(f,_,!0),c;if(d==null)break;if(s-_<d.head_length()){_=s;break}const l=new ArrayBuffer(d.head_length());if(d.write_head_bytes(new DataView(l),0),u.set(new Uint8Array(l).slice(0,Math.min(l.byteLength,s-_)),r),r+=d.head_length(),_+=d.head_length(),s-_<d.name_length()){_=s;break}d.write_name_bytes(u,r,s-_),r+=d.name_length(),_+=d.name_length(),i=d.d_next}return a.setUint32(f,_,!0),0}else return 8},fd_renumber(t,r){if(e.fds[t]!=null&&e.fds[r]!=null){const s=e.fds[r].fd_close();return s!=0?s:(e.fds[r]=e.fds[t],e.fds[t]=void 0,0)}else return 8},fd_seek(t,r,s,i){const f=new DataView(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const{ret:a,offset:u}=e.fds[t].fd_seek(r,s);return f.setBigInt64(i,u,!0),a}else return 8},fd_sync(t){return e.fds[t]!=null?e.fds[t].fd_sync():8},fd_tell(t,r){const s=new DataView(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const{ret:i,offset:f}=e.fds[t].fd_tell();return s.setBigUint64(r,f,!0),i}else return 8},fd_write(t,r,s,i){const f=new DataView(e.inst.exports.memory.buffer),a=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const u=m.read_bytes_array(f,r,s);let _=0;for(const c of u){const d=a.slice(c.buf,c.buf+c.buf_len),{ret:l,nwritten:h}=e.fds[t].fd_write(d);if(l!=0)return f.setUint32(i,_,!0),l;if(_+=h,h!=d.byteLength)break}return f.setUint32(i,_,!0),0}else return 8},path_create_directory(t,r,s){const i=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const f=new TextDecoder("utf-8").decode(i.slice(r,r+s));return e.fds[t].path_create_directory(f)}else return 8},path_filestat_get(t,r,s,i,f){const a=new DataView(e.inst.exports.memory.buffer),u=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const _=new TextDecoder("utf-8").decode(u.slice(s,s+i)),{ret:c,filestat:d}=e.fds[t].path_filestat_get(r,_);return d?.write_bytes(a,f),c}else return 8},path_filestat_set_times(t,r,s,i,f,a,u){const _=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const c=new TextDecoder("utf-8").decode(_.slice(s,s+i));return e.fds[t].path_filestat_set_times(r,c,f,a,u)}else return 8},path_link(t,r,s,i,f,a,u){const _=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null&&e.fds[f]!=null){const c=new TextDecoder("utf-8").decode(_.slice(s,s+i)),d=new TextDecoder("utf-8").decode(_.slice(a,a+u)),{ret:l,inode_obj:h}=e.fds[t].path_lookup(c,r);return h==null?l:e.fds[f].path_link(d,h,!1)}else return 8},path_open(t,r,s,i,f,a,u,_,c){const d=new DataView(e.inst.exports.memory.buffer),l=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const h=new TextDecoder("utf-8").decode(l.slice(s,s+i));w.log(h);const{ret:y,fd_obj:F}=e.fds[t].path_open(r,h,f,a,u,_);if(y!=0)return y;e.fds.push(F);const P=e.fds.length-1;return d.setUint32(c,P,!0),0}else return 8},path_readlink(t,r,s,i,f,a){const u=new DataView(e.inst.exports.memory.buffer),_=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const c=new TextDecoder("utf-8").decode(_.slice(r,r+s));w.log(c);const{ret:d,data:l}=e.fds[t].path_readlink(c);if(l!=null){const h=new TextEncoder().encode(l);if(h.length>f)return u.setUint32(a,0,!0),8;_.set(h,i),u.setUint32(a,h.length,!0)}return d}else return 8},path_remove_directory(t,r,s){const i=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const f=new TextDecoder("utf-8").decode(i.slice(r,r+s));return e.fds[t].path_remove_directory(f)}else return 8},path_rename(t,r,s,i,f,a){const u=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null&&e.fds[i]!=null){const _=new TextDecoder("utf-8").decode(u.slice(r,r+s)),c=new TextDecoder("utf-8").decode(u.slice(f,f+a));let{ret:d,inode_obj:l}=e.fds[t].path_unlink(_);if(l==null)return d;if(d=e.fds[i].path_link(c,l,!0),d!=0&&e.fds[t].path_link(_,l,!0)!=0)throw"path_link should always return success when relinking an inode back to the original place";return d}else return 8},path_symlink(t,r,s,i,f){const a=new Uint8Array(e.inst.exports.memory.buffer);return e.fds[s]!=null?(new TextDecoder("utf-8").decode(a.slice(t,t+r)),new TextDecoder("utf-8").decode(a.slice(i,i+f)),58):8},path_unlink_file(t,r,s){const i=new Uint8Array(e.inst.exports.memory.buffer);if(e.fds[t]!=null){const f=new TextDecoder("utf-8").decode(i.slice(r,r+s));return e.fds[t].path_unlink_file(f)}else return 8},poll_oneoff(t,r,s){if(s===0)return 28;if(s>1)return w.log("poll_oneoff: only a single subscription is supported"),58;const i=new DataView(e.inst.exports.memory.buffer),f=N.read_bytes(i,t),a=f.eventtype,u=f.clockid,_=f.timeout;if(a!==D)return w.log("poll_oneoff: only clock subscriptions are supported"),58;let c;if(u===1)c=()=>BigInt(Math.round(performance.now()*1e6));else if(u===0)c=()=>BigInt(new Date().getTime())*1000000n;else return 28;const d=(f.flags&x)!==0?_:c()+_;for(;d>c(););return new T(f.userdata,0,a).write_bytes(i,r),0},proc_exit(t){throw new U(t)},proc_raise(t){throw"raised signal "+t},sched_yield(){},random_get(t,r){const s=new Uint8Array(e.inst.exports.memory.buffer).subarray(t,t+r);if("crypto"in globalThis&&(typeof SharedArrayBuffer>"u"||!(e.inst.exports.memory.buffer instanceof SharedArrayBuffer)))for(let i=0;i<r;i+=65536)crypto.getRandomValues(s.subarray(i,i+65536));else for(let i=0;i<r;i++)s[i]=Math.random()*256|0},sock_recv(t,r,s){throw"sockets not supported"},sock_send(t,r,s){throw"sockets not supported"},sock_shutdown(t,r){throw"sockets not supported"},sock_accept(t,r){throw"sockets not supported"}}}};class S{fd_allocate(n,o){return 58}fd_close(){return 0}fd_fdstat_get(){return{ret:58,fdstat:null}}fd_fdstat_set_flags(n){return 58}fd_fdstat_set_rights(n,o){return 58}fd_filestat_get(){return{ret:58,filestat:null}}fd_filestat_set_size(n){return 58}fd_filestat_set_times(n,o,R){return 58}fd_pread(n,o){return{ret:58,data:new Uint8Array}}fd_prestat_get(){return{ret:58,prestat:null}}fd_pwrite(n,o){return{ret:58,nwritten:0}}fd_read(n){return{ret:58,data:new Uint8Array}}fd_readdir_single(n){return{ret:58,dirent:null}}fd_seek(n,o){return{ret:58,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:58,offset:0n}}fd_write(n){return{ret:58,nwritten:0}}path_create_directory(n){return 58}path_filestat_get(n,o){return{ret:58,filestat:null}}path_filestat_set_times(n,o,R,g,e){return 58}path_link(n,o,R){return 58}path_unlink(n){return{ret:58,inode_obj:null}}path_lookup(n,o){return{ret:58,inode_obj:null}}path_open(n,o,R,g,e,t){return{ret:54,fd_obj:null}}path_readlink(n){return{ret:58,data:null}}path_remove_directory(n){return 58}path_rename(n,o,R){return 58}path_unlink_file(n){return 58}}class I extends S{signal;length;data;constructor(n){super(),this.signal=new Int32Array(n,0,1),this.length=new Int32Array(n,4,1),this.data=new Uint8Array(n,8)}fd_read(n){for(;Atomics.load(this.signal,0)===0;)Atomics.wait(this.signal,0,0);if(Atomics.load(this.signal,0)===-1)return{ret:0,data:new Uint8Array(0)};const o=Atomics.load(this.length,0),R=Math.min(o,n),g=new Uint8Array(R);return g.set(this.data.subarray(0,R)),Atomics.store(this.signal,0,0),{ret:0,data:g}}fd_fdstat_get(){return{ret:0,fdstat:new E(p,0)}}}class A extends S{stream;constructor(n){super(),this.stream=n}fd_write(n){const o=new TextDecoder().decode(n);return self.postMessage({type:this.stream,data:o}),{ret:0,nwritten:n.byteLength}}fd_fdstat_get(){return{ret:0,fdstat:new E(p,0)}}}self.onmessage=async O=>{if(O.data.type==="start"){const{wasmBytes:n,stdinBuffer:o,args:R,env:g}=O.data,e=new I(o),t=new A("stdout"),r=new A("stderr"),s=[e,t,r],i=new k(R,g,s);try{const f=await WebAssembly.compile(n),a=await WebAssembly.instantiate(f,{wasi_snapshot_preview1:i.wasiImport}),u=i.start(a);self.postMessage({type:"exit",code:u})}catch(f){const a=f instanceof Error?f.message:String(f);self.postMessage({type:"stderr",data:`Error: ${a}\r
`}),self.postMessage({type:"exit",code:1})}}}})();
